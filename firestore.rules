rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Hilfsfunktion: Validiert das Username-Format (Tiername-6Zeichen)
    function isValidUsername(username) {
      // Format: Tiername-6Zeichen (z.B. "Hase-AbC123")
      // Prüfe: Mindestens 1 Buchstabe, dann Bindestrich, dann genau 6 alphanumerische Zeichen
      return username.matches('^[A-Za-zäöüßÄÖÜ]+-[A-Za-z0-9]{6}$');
    }

      // Hilfsfunktion: Rolle aus author Collection holen
      function getUserRole(uid) {
        return get(/databases/$(database)/documents/author/$(uid)).data.role;
      }
    
    // Users Collection - Streng kontrolliert
    match /users/{userId} {
      // Jeder kann lesen (nur um zu prüfen, ob Username existiert)
      allow read: if true;
      
      // Erstellen erlaubt: validem Username-Format (keine Auth nötig, da anonym)
      allow create: if isValidUsername(userId);
      
      // Nur der Benutzer selbst darf sein Dokument ändern (falls später authentifiziert)
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // Löschen nicht erlaubt
      allow delete: if false;
      
      // Progress-Subcollection - Lesen/Schreiben erlaubt (geschützt durch Username-Validierung)
      match /progress/{quizId} {
        allow read, write: if true;
      }
    }
    
    // Quiz Challenges - Lesen für alle, Schreiben nur für Admins
    match /quizChallenges/{challengeId} {
      // Jeder kann Challenges lesen (für Quiz-Teilnehmer)
      allow read: if true;
      
      // Nur eingeloggte Admins können Challenges erstellen/ändern/löschen
      allow create, update, delete: if request.auth != null;
    }
    
    // System Config - Lesen für alle, Schreiben nur für Admins
    match /systemConfig/{configId} {
      // Jeder kann System-Config lesen (für Wartungsmodus-Check)
      allow read: if true;
      
      // Nur eingeloggte Admins können Config ändern
      allow create, update, delete: if request.auth != null;
    }
    
    // Quiz Results / Progress (falls du das später trackst)
    match /quizResults/{resultId} {
      allow read, write: if request.auth != null;
    }
    
    // Quizzes Collection - Neue eigenständige Quiz-Sammlung
    // Ermöglicht flexible Zuordnung zu Fächern, Klassen und Themen
    match /quizzes/{quizId} {
      // Jeder kann Quizze lesen (für Quiz-Teilnehmer)
      allow read: if true;
      
        // Create: admin, teacher, supporter
        allow create: if request.auth != null
          && getUserRole(request.auth.uid) in ['admin', 'teacher', 'supporter']
          && request.resource.data.authorId == request.auth.uid;

        // Update: admin, teacher, supporter (supporter cannot set visible)
          allow update: if request.auth != null && (
            getUserRole(request.auth.uid) == 'admin' ||
            ((getUserRole(request.auth.uid) in ['teacher', 'supporter'])
              && resource.data.authorId == request.auth.uid
              && ('hidden' in request.resource.data && request.resource.data.hidden == true)
            )
          );

        // Delete: admin, teacher (teacher can only delete their own quizzes)
        allow delete: if request.auth != null && (
          getUserRole(request.auth.uid) == 'admin' ||
          (getUserRole(request.auth.uid) == 'teacher' && resource.data.authorId == request.auth.uid)
        );
    }
    
    // Author Collection - Speichert Author-Abbreviations
    match /author/{authorId} {
      // Nur eingeloggte Admins können Author-Daten lesen
      allow read: if request.auth != null;
      
      // Nur eingeloggte Admins können Author-Daten erstellen/ändern/löschen
      allow create, update, delete: if request.auth != null;
    }
  }
}