rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Hilfsfunktion: Validiert das Username-Format (Tiername-6Zeichen)
    function isValidUsername(username) {
      // Format: Tiername-6Zeichen (z.B. "Hase-AbC123")
      // Prüfe: Mindestens 1 Buchstabe, dann Bindestrich, dann genau 6 alphanumerische Zeichen
      return username.matches('^[A-Za-zäöüßÄÖÜ]+-[A-Za-z0-9]{6}$');
    }
    
    // Subjects Collection - Lesen für alle, Schreiben nur für authentifizierte User
    match /subjects/{subjectId} {
      // Jeder kann Subjects lesen (für Quiz-Teilnehmer)
      allow read: if true;
      
      // Nur eingeloggte Admins können Subjects erstellen/ändern/löschen
      allow create, update, delete: if request.auth != null;
    }
    
    // Users Collection - Streng kontrolliert
    match /users/{userId} {
      // Jeder kann lesen (nur um zu prüfen, ob Username existiert)
      allow read: if true;
      
      // Erstellen erlaubt: validem Username-Format (keine Auth nötig, da anonym)
      allow create: if isValidUsername(userId);
      
      // Nur der Benutzer selbst darf sein Dokument ändern (falls später authentifiziert)
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // Löschen nicht erlaubt
      allow delete: if false;
      
      // Progress-Subcollection - Lesen/Schreiben erlaubt (geschützt durch Username-Validierung)
      match /progress/{quizId} {
        allow read, write: if true;
      }
    }
    
    // Quiz Results / Progress (falls du das später trackst)
    match /quizResults/{resultId} {
      allow read, write: if request.auth != null;
    }
  }
}